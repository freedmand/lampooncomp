<!DOCTYPE html>
<html lang="en">
<head>
	<title>Comp Submission</title>
	<link rel="stylesheet" type="text/css" href="css/comp.css">
	<link rel="stylesheet" type="text/css" href="css/fonts.css">
	<link rel="stylesheet" type="text/css" href="css/nicedit.css">
	
	<script src="js/jquery-1.8.3.js"></script>
	<script src="js/jquery-ui.js"></script>
	<script src="js/rangy-core.js"></script>
	<script src="js/rangy-cssclassapplier.js"></script>
	<script src="js/jquery.hotkeys.js"></script>
	
	<script type="text/javascript">
		var boldApplier, italicApplier, underlineApplier, commentApplier;
		
		$(document).delegate('.paper', 'keydown', function(e) {
			console.log(event.metaKey);
			var keyCode = e.keyCode || e.which;
			
			if (keyCode == 9)
			{
				e.preventDefault();
				var sel = rangy.getSelection();
				var range = sel.getRangeAt(0);
				range.deleteContents();
				var node = document.createTextNode("\t");
				range.insertNode(node);
				range.setStartAfter(node);
				range.collapse(true);
				sel.removeAllRanges();
				sel.addRange(range);
			}
			
			if ((event.metaKey || event.ctrlKey) && String.fromCharCode(keyCode).toUpperCase() == 'B')
				bold();
			else if ((event.metaKey || event.ctrlKey) && String.fromCharCode(keyCode).toUpperCase() == 'I')
				italic();
			else if ((event.metaKey || event.ctrlKey) && String.fromCharCode(keyCode).toUpperCase() == 'U')
				underline();
		});
		
		$('#file-upload').live('change', function()
		{
			console.log('change');
			var file = this.files[0];
			var xhr = new XMLHttpRequest();
			xhr.file = file;
			xhr.addEventListener('progress', function(e) {
				var done = e.position || e.loaded, total = e.totalSize || e.total;
				console.log('xhr progress: ' + (Math.floor(done/total*1000)/10) + '%');
			}, false);
			if (xhr.upload) {
				xhr.upload.onprogress = function(e) {
					var done = e.position || e.loaded, total = e.totalSize || e.total;
					console.log('xhr.upload progress: ' + done + ' / ' + total + ' = ' + (Math.floor(done/total*1000)/10) + '%');
				};
			}
			xhr.onreadystatechange = function(e) {
				if ( 4 == this.readyState ) {
					console.log(['xhr upload complete', e]);
				}
				// console.log(e.target.responseText);
				$('.paper').html(e.target.responseText);
			};
			xhr.open('post', 'upload.php', true);
			xhr.setRequestHeader("X-File-Name", file.name);
			xhr.send(file);
		});//, false);
		
		window.onload = function()
		{
			rangy.init();
			// boldApplier = rangy.createCssClassApplier("", {normalize: true, elementTagName: 'b'});
			// italicApplier = rangy.createCssClassApplier("text-italic", {normalize: true, elementTagName: 'i'});
			// underlineApplier = rangy.createCssClassApplier("text-underline", {normalize: true, elementTagName: 'u'});
			commentApplier = rangy.createCssClassApplier("comment-inline", {normalize: true, elementTagName: 'span', elementProperties: {'onclick': function () {alert("hell yeah!"); return false;}}});
			// $(document).on('selectionchange', updateButtons());
		};
		
		function updateButtons()
		{
			if (document.queryCommandState("bold"))
				$('#bold-button').removeClass('inactive-button').addClass('active-button');
			else
				$('#bold-button').removeClass('active-button').addClass('inactive-button');
			
			if (document.queryCommandState("italic"))
				$('#italic-button').removeClass('inactive-button').addClass('active-button');
			else
				$('#italic-button').removeClass('active-button').addClass('inactive-button');

			if (document.queryCommandState("underline"))
				$('#underline-button').removeClass('inactive-button').addClass('active-button');
			else
				$('#underline-button').removeClass('active-button').addClass('inactive-button');
		}
		
		function disableButtons()
		{
			console.log('disable');
			$('#bold-button').removeClass('active-button').addClass('inactive-button');
			$('#italic-button').removeClass('active-button').addClass('inactive-button');
			$('#underline-button').removeClass('active-button').addClass('inactive-button');
		}
		
		function bold()
		{
			console.log('yea');
			document.execCommand('bold');
			// boldApplier.toggleSelection();
			updateButtons();
		}
		function italic()
		{
			// italicApplier.toggleSelection();
			document.execCommand("italic");
			updateButtons();
			// document.execCommand('italic',false,null);
		}
		function underline()
		{
			// underlineApplier.toggleSelection();
			document.execCommand("underline");
			updateButtons();
			// document.execCommand('underline',false,null);
		}
		function comment()
		{
			if ($('.comment-pane').css('display') == 'none')
				$('.comment-pane').fadeIn(200);
				// $('.comment-pane').show("slide", { direction: "left" }, 1000);
			commentApplier.toggleSelection();
			var text = rangy.getSelection().toString();
			var div = document.createElement('div');
			div.className = "comment-inactive";
			div = $(div);
			div.html(text);
			$('.comment-pane').append(div);
		}
	</script>
</head>
<body class="main">

	<form enctype="multipart/form-data" action="upload.php" method="POST">
	
		<table style="margin-left: auto; margin-right: auto; table-layout: fixed;">
			<tr>
				<td class="panel">
					<button id="bold-button" class="formatting-button inactive-button" style="background-image: url('img/bold.png');" onclick="bold();"></button>
					<button id="italic-button" class="formatting-button inactive-button" style="background-image: url('img/italic.png');" onclick="italic();"></button>
					<button id="underline-button" class="formatting-button inactive-button" style="background-image: url('img/underline.png');" onclick="underline();"></button>
					<button id="comment-button" class="formatting-button inactive-button" style="background-image: url('img/comment.png');" onclick="comment();"></button>
					<button id="word-button" class="formatting-button inactive-button" style="background-image: url('img/word.png');" onclick="$('#file-upload').trigger('click'); return false;"></button>
					<input type="file" id="file-upload" name="file" style="display:none" />
				</td>
				<td></td>
			</tr>
			<tr>
				<td>
					<div class="paper-holder paper-text">
						<div class="top-bar"></div>
						<input type="text" class="paper-title" placeholder="Click to edit title...">
							<div class="paper" contenteditable="true" onblur="disableButtons();" onchange="updateButtons();" onfocus="updateButtons();" onselect="updateButtons();" onkeydown="updateButtons();" onkeyup="updateButtons();" onmousedown="updateButtons();" onmouseup="updateButtons();"></div>
					</div>
				</td>
				<td>
					<!-- <div id="commentpane-expand" style="width: 0; overflow: hidden;"> -->
						<div class="comment-pane" style="display: none;">
							<div class='pane-header'>Feedback</div>
						</div>
					<!-- </div> -->
				</td>
			</tr>
		</table>
	 </form>
</body>
</html>